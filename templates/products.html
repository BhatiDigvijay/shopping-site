<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Products - Ayurvedic Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --green-1:#3d5a40;
      --green-2:#5a7f65;
      --green-3:#2b4d3a;
      --bg:#f9f6f1;
      --leaf:#b0e57c;
      --text:#2e2e2e;
    }
    body {
      font-family: "Poppins", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
    }
    nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 15px 20px;
      background: var(--green-1);
    }
    nav button {
      background: var(--green-2);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 25px;
      cursor: pointer;
      transition: 0.2s;
    }
    nav button:hover { background: var(--green-1); }

    .controls {
      display: flex;
      gap: 10px;
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .controls input, .controls select {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background:#fff;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto 80px;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
    }

    .product-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: transform 0.2s ease;
      position: relative;
      padding-bottom: 15px;
    }
    .product-card:hover { transform: translateY(-5px); }

    .product-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .product-card h2 {
      margin: 10px 20px 5px;
      color: var(--green-1);
      font-size: 1.2rem;
    }

    .product-card p {
      margin: 5px 20px;
      color: #555;
    }

    .price {
      font-weight: bold;
      color: var(--green-3);
      margin: 10px 20px;
    }

    .btn, .add-to-cart, .toggle-reviews-btn {
      background: linear-gradient(135deg, var(--green-2), var(--green-3));
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      margin: 5px 10px;
    }
    .btn:hover, .add-to-cart:hover, .toggle-reviews-btn:hover { background: var(--green-1); }

    .qty-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    .qty-selector button {
      width: 30px; height: 30px;
      border-radius: 50%;
      font-weight: bold;
      border:none;
      background:#eee;
      cursor:pointer;
    }
    .qty-selector button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    /* Cart count bump animation */
    #cartCount.bump {
      animation: bump 300ms ease;
    }
    @keyframes bump{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.25); }
      100%{ transform: scale(1); }
    }

    /* Reviews */
    .reviews {
      margin: 10px 20px;
      padding: 10px 0 0;
      border-top: 1px solid #e6e6e6;
    }
    .review-item { margin-bottom: 10px; }

    .average-rating{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      font-weight:600;
      color:#394d39;
    }
    .average-rating .avg-stars{
      font-size:1.1rem;
      letter-spacing:2px;
    }
    .average-rating small{ color:#666; font-weight:400; }

    /* Footer Policy Links */
    .policy-links {
      position: fixed;
      bottom: 10px;
      right: 20px;
      display: flex;
      flex-direction: row;
      gap: 15px;
      z-index: 999;
    }
    .policy-links a {
      color: var(--green-1);
      font-size: 0.85rem;
      text-decoration: none;
      transition: color 0.2s;
    }
    .policy-links a:hover {
      color: var(--leaf);
      text-decoration: underline;
    }

    /* Review Form Styles */
    .review-form {
      background-color: #f4f7ed;
      padding: 15px;
      border-radius: 12px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .review-form textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #cdd3c5;
      background-color: #f0f6ed;
      resize: none;
      margin-bottom: 6px;
      font-family: inherit;
    }
    .review-form .char-counter{
      text-align:right;
      font-size:.85rem;
      color:#666;
      margin-bottom:10px;
    }
    .review-form button[type="submit"] {
      background-color: #4b6a4f;
      color: #fffdf6;
      border: none;
      border-radius: 12px;
      padding: 10px;
      width: 100%;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .review-form button[type="submit"]:hover { background-color: #3e583f; }
    .review-form button[type="submit"][disabled]{ opacity:.7; cursor:not-allowed; }

    /* Stars (gradient fill + hover pop) */
    .star-selector {
      user-select:none;
      display:flex;
      gap:6px;
      margin-bottom:8px;
    }
    .star-selector span {
      font-size: 1.8rem;
      cursor: pointer;
      color: #cdd3c5;
      transition: transform 0.15s ease, color 0.2s ease;
      display:inline-block;
      line-height:1;
    }
    .star-selector span.selected, .star-selector span.hovered {
      background: linear-gradient(90deg, #f7d000, #ffae00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      transform: translateY(-1px) scale(1.05);
    }

    /* Toasts with icons */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border-radius: 12px;
      padding: 10px 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      font-weight: 500;
      z-index: 2000;
      animation: slideUp 0.25s ease, fadeOut 0.5s ease 2.6s forwards;
    }
    .toast.success { border-left: 5px solid #4b6a4f; }
    .toast.error { border-left: 5px solid #c0392b; }
    .toast .icon { font-size:1.1rem; }

    @keyframes slideUp {
      from { transform: translate(-50%, 20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    @keyframes fadeOut { to { opacity: 0; transform: translate(-50%, 20px);} }
  </style>
</head>
<body>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <nav>
    <button onclick="location.href='{{ url_for('home') }}'">üè† Home</button>
    <button onclick="location.href='{{ url_for('products_page') }}'">üõçÔ∏è Products</button>
    <button onclick="location.href='{{ url_for('cart_page') }}'">üõí Cart <span id="cartCount" style="background:red;color:white;padding:2px 8px;border-radius:50%;font-size:12px;">0</span></button>
    <button onclick="location.href='{{ url_for('about_page') }}'">üë©‚Äç‚öïÔ∏è About Us</button>
    <button onclick="location.href='{{ url_for('contact_page') }}'">üìû Contact Us</button>
  </nav>

  <div class="controls">
    <input type="text" id="searchBox" placeholder="Search products..." />
    <select id="sortBox">
      <option value="">Sort by</option>
      <option value="low">Price: Low to High</option>
      <option value="high">Price: High to Low</option>
    </select>
  </div>

  <div class="container" id="productList"></div>

  <!-- legacy node kept but no longer directly used -->
  <div id="toast" style="display:none;"></div>

  <!-- Footer Policy Links -->
  <div class="policy-links">
    <a href="{{ url_for('refund_page') }}">Cancellation & Refunds</a>
    <a href="{{ url_for('privacy_page') }}">Privacy Policy</a>
    <a href="{{ url_for('terms_page') }}">Terms & Conditions</a>
    <a href="{{ url_for('shipping_page') }}">Shipping Policy</a>
  </div>

  <script>
    const staticUrl = "{{ url_for('static', filename='') }}";

    const products = [
      { id: "1", name: "3-1 Face Wash", price: 149, image: staticUrl + "images/31facewash.jpeg", description: "Cleanses, exfoliates & moisturizes naturally." },
      { id: "2", name: "Multi-Action Fairness Cream", price: 199, image: staticUrl + "images/facecream.jpeg", description: "Ayurvedic herbs nourish & hydrate skin." },
      { id: "3", name: "Anti-Dandruff Shampoo", price: 129, image: staticUrl + "images/antidandruffshampoo.jpeg", description: "Strengthens hair & prevents dandruff." }
    ];

    let filteredProducts = [...products];

    // --- Initialize Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAVUAGmSy8unzvHF9qDwQ8VsBA_D1tBdMc",
      authDomain: "review-b714a.firebaseapp.com",
      databaseURL: "https://review-b714a-default-rtdb.firebaseio.com",
      projectId: "review-b714a",
      storageBucket: "review-b714a.firebasestorage.app",
      messagingSenderId: "656434016005",
      appId: "1:656434016005:web:94d7f104b244db338c916c",
      measurementId: "G-V8JE9FY1LX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Simple in-memory cache for reviews per product
    const reviewCache = new Map(); // productId -> { items: [...], loaded: true }

    // --- Utils ---
    function debounce(fn, delay=300){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    }

    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      const icon = document.createElement("span");
      icon.className = "icon";
      icon.textContent = type === "success" ? "‚úÖ" : "‚ö†Ô∏è";
      const text = document.createElement("span");
      text.textContent = message;
      toast.appendChild(icon);
      toast.appendChild(text);
      document.body.appendChild(toast);
      setTimeout(()=> toast.remove(), 3000);
    }

    function renderAvgStars(rating){
      // Return a string like ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ plus numeric
      const full = Math.floor(rating);
      const hasHalf = (rating - full) >= 0.5;
      let s = "‚òÖ".repeat(full);
      if (hasHalf) s += "‚òÜ"; // simple half representation (can be upgraded to SVG)
      s = s.padEnd(5, "‚òÜ");
      return s;
    }

    // --- Reviews ---
    async function fetchReviews(productId){
      const snap = await db.collection("reviews").where("productId","==",productId).orderBy("timestamp","desc").get();
      return snap.docs.map(d=>d.data());
    }

    function renderReviews(list, container, avgContainer){
      if (!list.length){
        container.innerHTML = "<i>No reviews yet. Be the first!</i>";
        avgContainer.querySelector(".avg-stars").textContent = "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
        avgContainer.querySelector(".avg-num").textContent = "-";
        avgContainer.querySelector(".count").textContent = "0";
        return;
      }
      container.innerHTML = "";
      let total = 0;
      list.forEach(r=>{
        total += Number(r.rating)||0;
        const el = document.createElement("div");
        el.className = "review-item";
        const stars = "‚≠êÔ∏è".repeat(r.rating);
        el.innerHTML = `
          <div class="stars" style="margin-bottom:2px;">${stars}</div>
          <div>${r.review}</div>
          <small style="color:#666;font-size:12px;">${new Date(r.timestamp).toLocaleString()}</small>
        `;
        container.appendChild(el);
      });
      const avg = total / list.length;
      avgContainer.querySelector(".avg-stars").textContent = renderAvgStars(avg);
      avgContainer.querySelector(".avg-num").textContent = avg.toFixed(1);
      avgContainer.querySelector(".count").textContent = String(list.length);
    }

    function attachReviewEvents(card, product) {
      const form = card.querySelector(".review-form");
      const starSelector = card.querySelector(".star-selector");
      const hiddenRating = form.querySelector("input[name='rating']");
      const textarea = form.querySelector("textarea[name='review']");
      const counter = form.querySelector(".char-counter");
      const submitBtn = form.querySelector("button[type='submit']");

      // Stars: hover + click with gradient fill
      const stars = Array.from(starSelector.querySelectorAll("span"));
      const setVisual = (value, hover=false)=>{
        stars.forEach((s,i)=>{
          const idx = i+1;
          s.textContent = idx <= value ? "‚òÖ" : "‚òÜ";
          s.classList.toggle("selected", idx <= value);
          s.classList.toggle("hovered", hover && idx <= value);
        });
      };
      stars.forEach(s=>{
        s.addEventListener("mouseover", ()=> setVisual(Number(s.dataset.value), true));
        s.addEventListener("mouseout", ()=> setVisual(Number(hiddenRating.value), false));
        s.addEventListener("click", ()=>{
          const value = Number(s.dataset.value);
          hiddenRating.value = value;
          setVisual(value, false);
        });
      });

      // Char counter
      const maxLen = textarea.getAttribute("maxlength") ? Number(textarea.getAttribute("maxlength")) : 200;
      const updateCounter = ()=> { counter.textContent = `${textarea.value.length}/${maxLen}`; };
      textarea.setAttribute("maxlength", String(maxLen));
      textarea.addEventListener("input", updateCounter);
      updateCounter();

      // Submit
      form.addEventListener("submit", async e => {
        e.preventDefault();
        const rating = Number(form.rating.value);
        const reviewText = textarea.value.trim();

        if (rating === 0) { showToast("Please select a star rating!", "error"); return; }
        if (reviewText.length < 10) { showToast("Please write at least 10 characters.", "error"); return; }

        try{
          submitBtn.disabled = true;
          submitBtn.textContent = "Submitting...";
          await db.collection("reviews").add({
            productId: product.id,
            rating,
            review: reviewText,
            timestamp: new Date().toISOString()
          });

          // update cache immediately
          const cached = reviewCache.get(product.id) || { items: [], loaded: true };
          cached.items.unshift({ productId: product.id, rating, review: reviewText, timestamp: new Date().toISOString() });
          reviewCache.set(product.id, cached);

          // Re-render list + average
          const reviewListEl = card.querySelector(".review-list");
          const avgRatingElContainer = card.querySelector(".average-rating");
          renderReviews(cached.items, reviewListEl, avgRatingElContainer);

          // reset form
          form.reset();
          hiddenRating.value = 0;
          setVisual(0,false);
          updateCounter();
          showToast("Review submitted!", "success");
        } catch(err){
          console.error(err);
          showToast("Failed to submit review.", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Review";
        }
      });
    }

    // Load reviews only when opened (and cache them)
    async function ensureReviewsLoaded(card, productId){
      const reviewListEl = card.querySelector(".review-list");
      const avgRatingElContainer = card.querySelector(".average-rating");

      if (reviewCache.has(productId)){
        const cached = reviewCache.get(productId);
        renderReviews(cached.items, reviewListEl, avgRatingElContainer);
        return;
      }
      reviewListEl.innerHTML = "Loading reviews...";
      try{
        const items = await fetchReviews(productId);
        reviewCache.set(productId, { items, loaded: true });
        renderReviews(items, reviewListEl, avgRatingElContainer);
      }catch(err){
        console.error("Error loading reviews:", err);
        reviewListEl.innerHTML = "<i>Error loading reviews</i>";
      }
    }

    // --- Cart + quantity ---
    function attachProductEvents() {
      document.querySelectorAll(".product-card").forEach(card => {
        let quantity = 1;
        const plusBtn = card.querySelector(".plus");
        const minusBtn = card.querySelector(".minus");
        const qtyDisplay = card.querySelector(".qty");
        const addToCartBtn = card.querySelector(".add-to-cart");

        const syncMinusState = ()=> { minusBtn.disabled = quantity <= 1; };
        syncMinusState();

        plusBtn.addEventListener("click", e => { e.stopPropagation(); quantity++; qtyDisplay.textContent = quantity; syncMinusState(); });
        minusBtn.addEventListener("click", e => { e.stopPropagation(); if(quantity>1){quantity--; qtyDisplay.textContent=quantity; } syncMinusState(); });

        addToCartBtn.addEventListener("click", e => {
          e.stopPropagation();
          const product = {
            id: card.dataset.id,
            name: card.querySelector("h2").textContent,
            price: parseFloat(card.querySelector(".price").textContent.replace(/[^\d.]/g,'')),
            qty: quantity,
            image: card.querySelector("img").src
          };
          let cart = JSON.parse(localStorage.getItem("cart")) || [];
          const existing = cart.find(i=>i.id===product.id);
          if(existing) existing.qty+=quantity; else cart.push(product);
          localStorage.setItem("cart", JSON.stringify(cart));
          showToast('Added to cart', "success");
          updateCartCount();
          quantity = 1; qtyDisplay.textContent = quantity; syncMinusState();
        });
      });
    }

    function updateCartCount(){
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const total = cart.reduce((sum,item)=>sum+item.qty,0);
      const el = document.getElementById("cartCount");
      el.textContent = total;
      el.classList.remove("bump");
      // reflow to restart animation
      void el.offsetWidth;
      el.classList.add("bump");
    }

    // --- Render products ---
    async function renderProducts() {
      const container = document.getElementById("productList");
      container.innerHTML = "";

      for (const product of filteredProducts) {
        const card = document.createElement("div");
        card.className = "product-card";
        card.dataset.id = product.id;

        card.innerHTML = `
          <img src="${product.image}" alt="${product.name}">
          <h2>${product.name}</h2>
          <p class="price">‚Çπ${product.price}</p>
          <p class="description" style="display:none;">${product.description}</p>

          <button class="toggle-reviews-btn">Show Reviews</button>
          <div class="reviews" style="display:none;">
            <div class="average-rating" data-product-id="${product.id}">
              <span class="avg-stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
              <span class="avg-num">-</span>
              <small>(<span class="count">0</span> reviews)</small>
            </div>

            <div class="review-list">‚Äî</div>

            <!-- Review Form -->
            <form class="review-form" data-product-id="${product.id}">
              <div class="star-selector">
                <span data-value="1">‚òÜ</span>
                <span data-value="2">‚òÜ</span>
                <span data-value="3">‚òÜ</span>
                <span data-value="4">‚òÜ</span>
                <span data-value="5">‚òÜ</span>
              </div>
              <input type="hidden" name="rating" value="0" required>
              <textarea name="review" rows="3" maxlength="200" placeholder="Share your Ayurvedic experience..."></textarea>
              <div class="char-counter">0/200</div>
              <button type="submit">Submit Review</button>
            </form>
          </div>

          <div class="qty-selector">
            <button class="minus">-</button>
            <span class="qty">1</span>
            <button class="plus">+</button>
          </div>
          <button class="add-to-cart">Add to Cart</button>
        `;

        container.appendChild(card);

        // Review expand/collapse + lazy load
        const toggleBtn = card.querySelector(".toggle-reviews-btn");
        const reviewsSection = card.querySelector(".reviews");
        toggleBtn.addEventListener("click", async () => {
          const nowOpen = reviewsSection.style.display !== "block";
          reviewsSection.style.display = nowOpen ? "block" : "none";
          toggleBtn.textContent = nowOpen ? "Hide Reviews" : "Show Reviews";
          if (nowOpen) {
            await ensureReviewsLoaded(card, product.id);
          }
        });

        attachReviewEvents(card, product);
      }

      attachProductEvents();
    }

    // --- Search + Sort (debounced search) ---
    document.getElementById("searchBox").addEventListener("input", debounce((e)=>{
      filteredProducts = products.filter(p=>p.name.toLowerCase().includes(e.target.value.toLowerCase()));
      renderProducts();
    }, 250));

    document.getElementById("sortBox").addEventListener("change",(e)=>{
      const sort=e.target.value;
      if(sort==="low"){filteredProducts.sort((a,b)=>a.price-b.price);}
      else if(sort==="high"){filteredProducts.sort((a,b)=>b.price-a.price);}
      renderProducts();
    });

    // --- Init ---
    renderProducts();
    updateCartCount();
  </script>
</body>
</html>
